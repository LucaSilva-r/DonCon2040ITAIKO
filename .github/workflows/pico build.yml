name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
    test_build:
        name: Build ITAIKO Firmware
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Install ARM GCC Toolchain
              run: |
                sudo apt-get update
                sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib
                arm-none-eabi-gcc --version

            - name: Checkout Pico SDK
              uses: actions/checkout@v4
              with:
                  repository: raspberrypi/pico-sdk
                  ref: 2.2.0
                  path: pico-sdk
                  submodules: recursive

            - name: Build Firmware
              run: |
                mkdir -p build
                cd build
                cmake .. \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DPICO_SDK_PATH=${{ github.workspace }}/pico-sdk \
                  -DPICO_BOARD=waveshare_rp2040_zero
                make -j$(nproc)
                echo "=== Build Output Sizes ==="
                ls -lh *.uf2 *.elf 2>/dev/null || true

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ITAIKO-firmware
                  path: |
                    build/*.uf2
                    build/*.elf
                    build/*.bin
                    build/*.hex
